# StellasoraMaster 项目说明（中文）

返回首页： [README.md](README.md)

## 1. 项目简介

`StellasoraMaster` 是一个面向《星塔旅人》的自动化辅助项目，采用 **Python 后端 + Web 前端控制台 + 图像识别自动执行** 的架构。

项目核心目标：

- 通过 ADB 与模拟器通信（MuMu12 / 雷电 / 自定义）。
- 基于模板匹配与 OCR 完成自动化操作。
- 提供可视化 Web 控制台，支持任务启停、暂停恢复、实时监控、日志导出、配置管理、在线更新。

---

## 2. 技术栈

### 后端

- Python 3
- Flask（Web API + 页面服务）
- OpenCV / NumPy（图像处理与模板匹配）
- ddddocr（数字/文本识别）
- scrcpy-client + adbutils（可选截图链路）

### 前端

- Vue 3
- Vite

### 打包

- PyInstaller（`StellasoraMaster.spec`）
- PowerShell 脚本（`package.ps1`）

---

## 3. 项目结构总览

当前主要工作目录为：`Game_screenshotReed_Autowork`。

关键目录与文件：

- `launcher.py`：统一入口，支持 `--update` 分支与主程序启动。
- `run_app.py`：运行时入口，自动检查并安装关键依赖，启动 Flask 应用并自动打开浏览器。
- `update.py`：增量更新模块（版本检查、补丁下载、覆盖更新、重启程序）。
- `config.json`：本地配置文件（ADB、端口、语言、截图方式、邀约角色等）。
- `core/`：自动化核心引擎。
  - `base_task.py`：任务基类，封装截图、点击、滑动、模板懒加载与中断睡眠。
  - `mumu_screenshot.py`：截图流核心，支持 `PNG/RAW/SCRCPY` 模式与健康自愈。
  - `daily_tasks.py`：日常任务流程。
  - `tower_climber.py`：自动爬塔流程。
  - `start_game.py`：启动游戏并进入主界面流程。
  - `config.py`：配置读取、更新、缓存。
- `templates_zh-CN/`、`templates_zh-Hant/`：模板图片资源（简中/繁中）。
- `webapp/`：Web 服务与前端工程。
  - `app.py`：Flask 主服务，任务调度、流媒体、配置/日志/更新接口。
  - `frontend/src/App.vue`：控制台页面（任务执行、实时监控、设置、更新）。
  - `static/`：前端构建产物（存在时后端直接返回 `static/index.html`）。

---

## 4. 运行机制（端到端）

## 4.1 启动链路

1. 执行 `launcher.py`。
2. 若传入 `--update`，进入更新流程；否则导入并运行 `run_app.main()`。
3. `run_app.py` 在非冻结环境下自动检查缺失依赖并通过镜像安装。
4. Flask 服务启动后自动打开浏览器页签。

## 4.2 任务执行链路

1. 前端点击“开始执行”，调用 `POST /task/start`。
2. 后端进行任务启动前检查（如 ADB 连接、显示器信息探测）。
3. 创建任务线程并维护状态（`running/paused/stopped/finished`）。
4. 任务内部通过截图 -> 识别 -> 点击/滑动 -> 校验 的循环执行。
5. 可通过 `pause/resume/stop` 接口动态控制。

## 4.3 实时监控链路

1. 前端请求 `/stream/start` 开启预览状态。
2. `/video_feed` 输出 MJPEG 图像流。
3. 后端持续调用截图工具并在画面上附加 FPS 信息。
4. 前端支持暂停监控与刷新连接。

---

## 5. 已实现核心功能

## 5.1 任务执行

- 日常任务（可细粒度勾选子任务）：
  - 主页面互动
  - 商店奖励
  - 委托派遣
  - 好友管理（含添加数量参数）
  - 赠送礼物
  - 邀约（支持 5 角色配置）
  - 秘纹升级
  - 旅人升级
  - 日常奖励领取
- 自动爬塔：
  - 属性选择：光/地、水/风、火/暗
  - 模式选择：快速 / 标准
  - 可指定次数（`0` 表示不限，通常直到周常达标）
- 组合任务：支持“日常 + 爬塔”等串行执行。

## 5.2 截图与稳定性

- 支持 `PNG`、`RAW`（前端可选），`SCRCPY`（后端支持但前端默认降级以提升稳定性）。
- 截图流具备健康检查和自恢复策略（卡帧、无帧、连接异常时重启/重连）。

## 5.3 配置与持久化

- 前端设置页读写 `config.json`。
- 邀约角色配置会写入后端配置，同时前端本地也有兜底存储。
- 支持多模拟器配置组（`emulator_configs`）。

## 5.4 日志与更新

- 后端将 `print` 与 logging 统一汇总到内存日志队列。
- 前端可轮询查看日志、导出日志文件。
- 内置版本检查与自动更新流程（远端 `version.json` + 补丁包）。

---

## 6. 配置文件说明（`config.json`）

常见字段：

- `adb_path`：ADB 可执行文件路径。
- `default_instance`：默认实例编号。
- `adb_port`：ADB 连接端口（例如 MuMu12 常用 `16384`，雷电常用 `5555`）。
- `server_lang`：模板语言，`zh-CN` 或 `zh-Hant`。
- `emulator_type`：`MuMu12` / `LDPlayer` / `Custom`。
- `emulator_configs`：不同模拟器预设路径与端口。
- `screenshot_method`：截图模式（建议 `RAW` 或 `PNG`）。
- `invitation_characters`：邀约角色数组（长度 5）。

---

## 7. 开发环境运行指南

在 `Game_screenshotReed_Autowork` 目录下：

1. 安装依赖

```bash
pip install -r requirements.txt
```

2. 启动程序

```bash
python launcher.py
```

或：

```bash
python run_app.py
```

3. 打开浏览器访问：

`http://127.0.0.1:5000/`（默认端口，若占用会自动顺延）

---

## 8. 主要接口清单（后端 `webapp/app.py`）

### 系统与更新

- `GET /system/version`：获取本地版本。
- `GET /system/check_update`：检查远端更新信息。
- `POST /system/start_update`：启动更新程序。

### 任务控制

- `POST /task/start`：启动任务。
- `POST /task/stop`：停止任务。
- `POST /task/pause`：暂停任务。
- `POST /task/resume`：恢复任务。
- `GET /task/status`：获取当前任务状态。

### 监控与截图

- `GET /video_feed`：MJPEG 画面流。
- `GET /stream/start`：开启预览。
- `GET /stream/stop`：暂停预览。
- `GET /stream/status`：获取预览与底层流状态。
- `POST /api/test_latency`：截图延迟测试。

### 配置

- `GET /config`：读取配置。
- `POST /config`：更新配置。
- `POST /config/test_adb`：测试 ADB 连接。

### 日志与健康

- `GET /logs`：拉取增量日志。
- `GET /logs/export`：导出日志文本。
- `GET /health`：健康检查。

---

## 9. 打包与发布

项目使用 PyInstaller + 脚本组合打包：

- 规范文件：`StellasoraMaster.spec`
- 脚本：`package.ps1`

典型流程：

1. 安装打包依赖（脚本中已包含）。
2. 执行 PyInstaller 产出 `dist/StellasoraMaster`。
3. 拷贝 `core/`、`webapp/`、模板目录、`config.json`、`version.txt` 到产物目录。

发布建议：

- 确保 `version.txt` 与远端 `version.json` 版本策略一致。
- 补丁包内目录结构保持与安装目录一致，避免更新覆盖异常。

---

## 10. 维护建议与注意事项

- 模板资源与语言目录要同步维护（`templates_zh-CN` / `templates_zh-Hant`）。
- 若新增任务步骤，优先复用 `BaseTask` 的点击等待与可中断睡眠能力。
- 截图问题排查建议：先用设置页测试连接，再做截图延迟测试。
- 若任务无响应，优先检查：ADB 路径、端口、模拟器是否在线、模板匹配阈值是否需要调整。

---

## 11. 版本与文档备注

本文档基于当前仓库结构与源码实现整理，适合作为开发交接与二次开发入口文档。
